version: '3.8'

services:
  # 1. Traefik Reverse Proxy & SSL Manager
  traefik:
    image: traefik:v2.11 # Upgraded to fix Docker API compatibility
    container_name: traefik
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --api.dashboard=true
      # HTTP to HTTPS Redirection
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      # ACME configuration for Production SSL (Green Lock)
      - --certificatesresolvers.letsencrypt.acme.tlsChallenge=true # CRITICAL: Added Challenge method
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme.json
      # NOTE: The staging server line is commented out or deleted for production
    ports:
      - "80:80"
      - "443:443"
      # (8080 dashboard port is commented out for security)
volumes:
      - /  var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/etc/traefik

  # 2. Frontend (Vue.js) - Serves the web assets
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      # Host Rule (Uses variable, no https:// prefix)
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure" # Plural fix
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80" # Nginx serves on port 80

  # 3. Auth API (Go) - Handles /api/auth/* requests
  auth-api:
    build:
      context: ./auth-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth-api.entrypoints=websecure"
      - "traefik.http.routers.auth-api.tls.certresolver=letsencrypt"
      # CRITICAL STRIP PREFIX MIDDLEWARE
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth-api.middlewares=auth-strip" # Attachment
      - "traefik.http.services.auth-api.loadbalancer.server.port=8081"

  # 4. Todos API (Node.js) - Handles /api/todos/* requests
  todos-api:
    build:
      context: ./todos-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.todos-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todos-api.entrypoints=websecure"
      - "traefik.http.routers.todos-api.tls.certresolver=letsencrypt"
      # CRITICAL STRIP PREFIX MIDDLEWARE
      - "traefik.http.middlewares.todos-strip.stripprefix.prefixes=/api/todos"
      - "traefik.http.routers.todos-api.middlewares=todos-strip"
      - "traefik.http.services.todos-api.loadbalancer.server.port=8082"

  # 5. Users API (Java Spring Boot) - Handles /api/users/* requests
  users-api:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.users-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.users-api.entrypoints=websecure"
      - "traefik.http.routers.users-api.tls.certresolver=letsencrypt"
      # CRITICAL STRIP PREFIX MIDDLEWARE
      - "traefik.http.middlewares.users-strip.stripprefix.prefixes=/api/users"
      - "traefik.http.routers.users-api.middlewares=users-strip"
      - "traefik.http.services.users-api.loadbalancer.server.port=8083"

  # 6. Redis Queue - Internal only
  redis-queue:
    image: redis:alpine
    # This port is exposed only to the Docker network internally

  # 7. Log Message Processor (Python) - Internal worker
  log-message-processor:
    build:
      context: ./log-message-processor
      dockerfile: Dockerfile
    env_file:
      - .env
    # No Traefik labels neededâ€”this is a worker service.
