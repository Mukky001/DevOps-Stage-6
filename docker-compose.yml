version: '3.8'

services:
  # 1. Traefik Reverse Proxy & SSL Manager
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      # Entry points for HTTP (80) and HTTPS (443)
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Enable Docker provider for dynamic configuration
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      # Enable API and Dashboard (optional, for debugging)
      - --api.dashboard=true
      # HTTP to HTTPS redirection globally
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      # ACME configuration for SSL certificates (Let's Encrypt Staging for testing)
      - --certificatesresolvers.letsencrypt.acme.email=your.email@example.com # CHANGE THIS
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme.json
      - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory # REMOVE FOR PROD
    ports:
      - "80:80"     # The Web entrypoint (redirects to 443)
      - "443:443"   # The WebSecure entrypoint
      # - "8080:8080" # Traefik Dashboard (optional)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/etc/traefik

  # 2. Frontend (Vue.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # Load environment variables from the root .env file
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      # Rule 1: Match traffic for the root domain (https://your-domain.com)
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME}`)" # CHANGE THIS
      - "traefik.http.routers.frontend.entrypoint=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80" # Nginx serves on port 80

  # 3. Auth API (Go)
  auth-api:
    build:
      context: ./auth-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      # Rule 2: Match traffic for /api/auth path
      - "traefik.http.routers.auth-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/auth`)" # CHANGE THIS
      - "traefik.http.routers.auth-api.entrypoint=websecure"
      - "traefik.http.routers.auth-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.auth-api.loadbalancer.server.port=8081"

  # 4. Todos API (Node.js)
  todos-api:
    build:
      context: ./todos-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      # Rule 3: Match traffic for /api/todos path
      - "traefik.http.routers.todos-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/todos`)" # CHANGE THIS
      - "traefik.http.routers.todos-api.entrypoint=websecure"
      - "traefik.http.routers.todos-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.todos-api.loadbalancer.server.port=8082"

  # 5. Users API (Java Spring Boot)
  users-api:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      # Rule 4: Match traffic for /api/users path
      - "traefik.http.routers.users-api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/users`)" # CHANGE THIS
      - "traefik.http.routers.users-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.users-api.entrypoint=websecure"
      - "traefik.http.services.users-api.loadbalancer.server.port=8083"

  # 6. Redis Queue
  redis-queue:
    image: redis:alpine
    # Redis uses port 6379 by default
    ports:
      - "6379:6379"

  # 7. Log Message Processor (Python)
  log-message-processor:
    build:
      context: ./log-message-processor
      dockerfile: Dockerfile
    env_file:
      - .env
    # This service is internal and does not need Traefik labels

volumes:
  traefik-certificates:

